#!/command/with-contenv bash
# Generate openclaw gateway configuration
source /etc/s6-overlay/lib/env-utils.sh

set -e
source_env_prefix OPENCLAW_

# OpenClaw requires any env vars consumed in config to exist or else it fails to start.
persist_env_var OPENCLAW_ \
  GRADIENT_API_KEY=change-me \
  OPENAI_API_KEY="${OPENAI_API_KEY:-change-me}" \
  COGNEE_API_TOKEN="${COGNEE_API_TOKEN:-change-me}" \
  TAILSCALE_ENABLE="${TAILSCALE_ENABLE:-false}" \
  TS_SOCKET="${TS_SOCKET}" \
  TS_EXTRA_ARGS="${TS_EXTRA_ARGS}" \
  TS_HOSTNAME="${TS_HOSTNAME}" \
  TS_STATE_DIR="${TS_STATE_DIR}" \
  TS_USERSPACE="${TS_USERSPACE}" \
  OPENCLAW_STATE_DIR=/data/.openclaw \
  OPENCLAW_WORKSPACE_DIR=/data/workspace

# Ensure directories exist (only if variables are set)
[ -n "$OPENCLAW_STATE_DIR" ] && mkdir -p "$OPENCLAW_STATE_DIR"
[ -n "$OPENCLAW_WORKSPACE_DIR" ] && mkdir -p "$OPENCLAW_WORKSPACE_DIR"

# Validate mutual exclusivity of ngrok and tailscale
if [ "${ENABLE_NGROK:-false}" = "true" ] && [ "${TAILSCALE_ENABLE:-false}" = "true" ]; then
  echo "[generate-config] WARNING: Both ENABLE_NGROK and TAILSCALE_ENABLE are true."
  echo "[generate-config] This doesn't make sense - ngrok is public, Tailscale is private."
  echo "[generate-config] Defaulting to Tailscale (disable ENABLE_NGROK to silence this)."
fi

# Setup openclaw user's .profile (used by login shells, no interactive check)
SOURCE_LINE="source /etc/s6-overlay/lib/env-utils.sh"
PROFILE="/home/openclaw/.profile"
# Create .profile if it doesn't exist
touch "$PROFILE"
chown openclaw:openclaw "$PROFILE"
# Append environment setup if not already present
if ! grep -qF "$SOURCE_LINE" "$PROFILE"; then
    cat >> "$PROFILE" <<'EOF'
# OpenClaw environment setup
source /etc/s6-overlay/lib/env-utils.sh 2>/dev/null || true
source_env_prefix OPENCLAW_ 2>/dev/null || true

# nvm
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

# pnpm
export PNPM_HOME="$HOME/.local/share/pnpm"
case ":$PATH:" in
  *":$PNPM_HOME:"*) ;;
  *) export PATH="$PNPM_HOME:$PATH" ;;
esac
EOF
    echo "Appended environment setup to $PROFILE"
fi

DEFAULT_CONFIG="/etc/openclaw/openclaw.default.json"
CONFIG_FILE="$OPENCLAW_STATE_DIR/openclaw.json"

echo "[generate-config] Building config: $CONFIG_FILE"

# Show version
echo "[generate-config] Checking openclaw installation..."
if ! command -v openclaw >/dev/null 2>&1; then
  echo "[generate-config] ERROR: openclaw command not found in PATH" >&2
  echo "[generate-config] PATH: $PATH" >&2
  echo "[generate-config] Node version: $(node --version 2>&1 || echo 'not found')" >&2
  exit 1
fi

echo "[generate-config] OpenClaw version: $(openclaw --version 2>/dev/null || echo 'unknown')"

# Generate a gateway token if not provided
if [ -z "$OPENCLAW_GATEWAY_TOKEN" ]; then
  OPENCLAW_GATEWAY_TOKEN=$(head -c 32 /dev/urandom | base64 | tr -d '=/+' | head -c 32)
  echo "[generate-config] Generated gateway token (ephemeral): $OPENCLAW_GATEWAY_TOKEN"
  echo "[generate-config] Save this token - you'll need it to connect to the Control UI"
fi

# Write token to s6 environment
persist_env_var OPENCLAW_ OPENCLAW_GATEWAY_TOKEN="$OPENCLAW_GATEWAY_TOKEN"
echo "[generate-config] Gateway token configured (OPENCLAW_GATEWAY_TOKEN)"

# Start with default config as base
if [ -f "$DEFAULT_CONFIG" ]; then
  cp "$DEFAULT_CONFIG" "$CONFIG_FILE"
  echo "[generate-config] Using default config from $DEFAULT_CONFIG"
else
  # Fallback minimal config if default doesn't exist
  echo '{"gateway": {"mode": "local"}}' > "$CONFIG_FILE"
  echo "[generate-config] Warning: Default config not found, using minimal config"
fi

# Handle ENABLE_UI flag - disable Control UI if set to false
if [ "${ENABLE_UI:-true}" = "false" ]; then
  echo "[generate-config] Disabling Control UI (ENABLE_UI=false)"
  jq '.gateway.controlUi.enabled = false' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
fi

# Add Tailscale config when enabled
if [ "${TAILSCALE_ENABLE:-false}" = "true" ]; then
  echo "[generate-config] Adding Tailscale serve config"
  jq '.gateway.tailscale.resetOnExit = true | .gateway.tailscale.mode = "serve" | .gateway.auth.allowTailscale = true' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
fi

# Add gateway auth token to config
echo "[generate-config] Adding gateway.auth.token to config"
jq --arg token "$OPENCLAW_GATEWAY_TOKEN" '.gateway.auth.token = $token | .gateway.auth.mode = "token"' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"

# Permissions applied via /etc/digitalocean/permissions.yaml

echo "[generate-config] Final config:"
jq '.' "$CONFIG_FILE"

# Install Cognee memory plugin if not already installed (non-fatal)
COGNEE_PLUGIN_DIR="$OPENCLAW_STATE_DIR/extensions/memory-cognee"
if [ ! -d "$COGNEE_PLUGIN_DIR" ] || [ ! -f "$COGNEE_PLUGIN_DIR/package.json" ]; then
  echo "[generate-config] Installing Cognee memory plugin..."
  (
    set +e  # Don't abort on errors in this subshell
    rm -rf "$COGNEE_PLUGIN_DIR"
    mkdir -p "$COGNEE_PLUGIN_DIR"
    # Download tarball URL from npm registry, then fetch and extract (no npm/node needed)
    TARBALL_URL=$(curl -sL "https://registry.npmjs.org/@cognee/cognee-openclaw/latest" | jq -r '.dist.tarball // empty')
    if [ -z "$TARBALL_URL" ]; then
      echo "[generate-config] WARNING: Could not resolve Cognee plugin tarball URL"
      exit 0
    fi
    echo "[generate-config] Downloading Cognee plugin from $TARBALL_URL"
    curl -sL "$TARBALL_URL" | tar xzf - -C "$COGNEE_PLUGIN_DIR" --strip-components=1
    EXTRACT_EXIT=$?
    if [ "$EXTRACT_EXIT" -ne 0 ]; then
      echo "[generate-config] WARNING: Cognee plugin extract failed (exit $EXTRACT_EXIT)"
      exit 0
    fi
    chown -R openclaw:openclaw "$COGNEE_PLUGIN_DIR"
    if [ -f "$COGNEE_PLUGIN_DIR/package.json" ]; then
      echo "[generate-config] Cognee plugin installed to $COGNEE_PLUGIN_DIR"
      # Install dependencies if node/npm available via nvm
      su - openclaw -c "export NVM_DIR=/home/openclaw/.nvm && . \$NVM_DIR/nvm.sh 2>/dev/null && cd '$COGNEE_PLUGIN_DIR' && npm install --production 2>&1" || echo "[generate-config] WARNING: npm install skipped (non-fatal)"
    else
      echo "[generate-config] WARNING: Cognee plugin package.json not found after extract"
    fi
  ) || echo "[generate-config] WARNING: Cognee plugin install failed (non-fatal)"
else
  echo "[generate-config] Cognee plugin already installed at $COGNEE_PLUGIN_DIR"
fi

persist_env_var OPENCLAW_

echo "[generate-config] Done generating config"
